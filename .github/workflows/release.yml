name: Build and Release

on:
    push:
        tags:
            - "v*.*.*" # Triggers on version tags like v1.0.25120905
    workflow_dispatch: # Allow manual trigger

jobs:
    prepare-version:
        name: Prepare Version
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get-version.outputs.version }}
            tag-name: ${{ steps.get-version.outputs.tag-name }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get version from tag or version.json
              id: get-version
              run: |
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                    # Extract version from tag (e.g., v1.0.25120905 -> 1.0.25120905)
                    VERSION="${GITHUB_REF#refs/tags/v}"
                    TAG_NAME="${GITHUB_REF#refs/tags/}"
                  else
                    # Read from version.json
                    VERSION=$(cat build/version.json | grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
                    TAG_NAME="v$VERSION"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
                  echo "ðŸ“¦ Building version: $VERSION"

    build-windows:
        name: Build Windows
        needs: prepare-version
        runs-on: windows-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Install Velopack CLI
              run: dotnet tool install --global vpk

            - name: Build Windows with Velopack
              run: .\build\windows-velopack.ps1
              shell: pwsh

            - name: Upload Windows artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: windows-release
                  path: |
                      dist/velopack/*.exe
                      dist/velopack/*.nupkg
                      dist/velopack/RELEASES
                  retention-days: 5

    build-macos:
        name: Build macOS (Apple Silicon)
        needs: prepare-version
        runs-on: macos-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Install Velopack CLI
              run: dotnet tool install --global vpk

            - name: Build macOS with Velopack
              run: |
                  chmod +x ./build/macos.sh
                  ./build/macos.sh Release arm64

            - name: Upload macOS artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: macos-arm64-release
                  path: |
                      dist/velopack-macos/arm64/*.zip
                      dist/velopack-macos/arm64/RELEASES
                  retention-days: 5

    create-release:
        name: Create GitHub Release
        needs: [prepare-version, build-windows, build-macos]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Display structure of downloaded files
              run: ls -R artifacts

            - name: Generate release notes
              id: release-notes
              run: |
                  VERSION="${{ needs.prepare-version.outputs.version }}"
                  cat > release-notes.md << 'EOF'
                  ## ðŸŽ‰ VBDLIS Tools v$VERSION

                  ### ðŸ“¦ Downloads

                  #### Windows
                  - **VbdlisTools-$VERSION-win-Setup.exe** - Installer cho ngÆ°á»i dÃ¹ng má»›i
                  - Há»— trá»£ auto-update qua Velopack

                  #### macOS
                  - **VbdlisTools-$VERSION-osx-arm64.zip** - Cho Mac M1/M2/M3/M4 (Apple Silicon)
                  - Há»— trá»£ auto-update qua Velopack
                  - **LÆ°u Ã½:** Chá»‰ há»— trá»£ Apple Silicon. Mac Intel (x64) khÃ´ng cÃ²n Ä‘Æ°á»£c há»— trá»£.

                  ### ðŸš€ Installation

                  **Windows:**
                  1. Táº£i file `VbdlisTools-$VERSION-win-Setup.exe`
                  2. Cháº¡y installer
                  3. á»¨ng dá»¥ng tá»± Ä‘á»™ng update khi cÃ³ phiÃªn báº£n má»›i

                  **macOS (Apple Silicon only):**
                  1. Táº£i file `VbdlisTools-$VERSION-osx-arm64.zip`
                  2. Giáº£i nÃ©n vÃ  kÃ©o `VbdlisTools.app` vÃ o thÆ° má»¥c Applications
                  3. Láº§n Ä‘áº§u cháº¡y: Right-click â†’ Open (Ä‘á»ƒ bypass Gatekeeper)
                  4. á»¨ng dá»¥ng tá»± Ä‘á»™ng update khi cÃ³ phiÃªn báº£n má»›i

                  ### âš ï¸ Important Notes

                  - **Playwright Browsers**: Sáº½ tá»± Ä‘á»™ng táº£i xuá»‘ng khi cháº¡y láº§n Ä‘áº§u tiÃªn
                  - **Auto-Update**: á»¨ng dá»¥ng tá»± Ä‘á»™ng kiá»ƒm tra vÃ  cáº­p nháº­t phiÃªn báº£n má»›i
                  - **Minimum Requirements**:
                    - Windows: Windows 10 64-bit or later
                    - macOS: macOS 10.15 (Catalina) or later

                  ### ðŸ› Bug Fixes & Improvements

                  - Cáº£i thiá»‡n hiá»‡u suáº¥t
                  - Sá»­a lá»—i vÃ  tá»‘i Æ°u hÃ³a

                  ---

                  **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.0...v$VERSION
                  EOF

                  # Replace $VERSION with actual version
                  sed -i "s/\$VERSION/$VERSION/g" release-notes.md

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.prepare-version.outputs.tag-name }}
                  name: Release ${{ needs.prepare-version.outputs.version }}
                  body_path: release-notes.md
                  draft: false
                  prerelease: false
                  files: |
                      artifacts/windows-release/*
                      artifacts/macos-arm64-release/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload to release server (optional)
              if: false # Enable this if you have a custom release server
              run: |
                  # Example: rsync or scp to your web server
                  # rsync -avz artifacts/ user@server:/path/to/releases/
                  echo "Upload to custom server disabled. Enable by setting 'if: true' above."
