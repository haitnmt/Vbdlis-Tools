name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.25120901
  workflow_dispatch: # Allow manual trigger
    inputs:
      app_update_notes:
        description: "Noi dung APP_UPDATE_NOTES (markdown, co the xuong dong)"
        required: false
        type: string

jobs:
  prepare-version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      assembly-version: ${{ steps.get-version.outputs.assembly-version }}
      tag-name: ${{ steps.get-version.outputs.tag-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag (uses version.json - no auto-increment)
        id: get-version
        run: |
          VERSION_FILE="src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/build-scripts/version.json"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "‚ùå Version file not found: $VERSION_FILE"
            exit 1
          fi

          FILE_VERSION=$(grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' "$VERSION_FILE" | cut -d'"' -f4)
          ASSEMBLY_VERSION=$(grep -o '"assemblyVersion"[[:space:]]*:[[:space:]]*"[^"]*"' "$VERSION_FILE" | cut -d'"' -f4)
          if [ -z "$FILE_VERSION" ] || [ -z "$ASSEMBLY_VERSION" ]; then
            echo "‚ùå Missing currentVersion or assemblyVersion in $VERSION_FILE"
            exit 1
          fi

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag (e.g., v1.0.25120901 -> 1.0.25120901)
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            if [ "$VERSION" != "$FILE_VERSION" ]; then
              echo "‚ùå Tag version ($VERSION) does not match locked version.json ($FILE_VERSION)"
              echo "Please run local build script first, then create release tag from create-release.ps1."
              exit 1
            fi
          else
            # Read from version.json (for manual trigger)
            VERSION="$FILE_VERSION"
            TAG_NAME="v$VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "assembly-version=$ASSEMBLY_VERSION" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION (Assembly: $ASSEMBLY_VERSION)"
          echo "üîí Using LOCKED version from version.json (no auto-increment)"

  build-windows:
    name: Build Windows
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Display locked version info
        run: |
          Write-Host "üîí Building Windows with LOCKED version from version.json" -ForegroundColor Green
          Write-Host "üì¶ Package Version: ${{ needs.prepare-version.outputs.version }}" -ForegroundColor Cyan
          Write-Host "üî¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}" -ForegroundColor Cyan
          Write-Host "‚ö†Ô∏è  No auto-increment on GitHub Actions build" -ForegroundColor Yellow
        shell: pwsh

      - name: Build Windows with Velopack (uses locked version from version.json)
        run: |
          $ProjectPath = "src\Haihv.Vbdlis.Tools\Haihv.Vbdlis.Tools.Desktop"
          $ProjectFile = Join-Path $ProjectPath "Haihv.Vbdlis.Tools.Desktop.csproj"
          $PublishPath = Join-Path $ProjectPath "bin\publish\velopack"
          $OutputPath = Join-Path $ProjectPath "dist\velopack"
          $Version = "${{ needs.prepare-version.outputs.version }}"
          $AssemblyVersion = "${{ needs.prepare-version.outputs.assembly-version }}"

          Write-Host "Cleaning previous outputs..." -ForegroundColor Yellow
          if (Test-Path $PublishPath) { Remove-Item $PublishPath -Recurse -Force }
          if (Test-Path $OutputPath) { Remove-Item $OutputPath -Recurse -Force }
          New-Item -ItemType Directory -Path $OutputPath -Force | Out-Null

          Write-Host "Building Windows with locked version..." -ForegroundColor Yellow
          dotnet publish $ProjectFile `
            -c Release `
            -o $PublishPath `
            -r win-x64 `
            --self-contained `
            -p:Version=$Version `
            -p:AssemblyVersion=$AssemblyVersion `
            -p:FileVersion=$AssemblyVersion `
            -p:InformationalVersion=$Version

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Build failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "Packaging with Velopack..." -ForegroundColor Yellow
          vpk pack `
            --packId "VbdlisTools" `
            --packVersion $Version `
            --packDir $PublishPath `
            --mainExe "Haihv.Vbdlis.Tools.Desktop.exe" `
            --outputDir $OutputPath `
            --icon "$ProjectPath\Assets\appicon.ico" `
            --packTitle "VBDLIS Tools" `
            --packAuthors "Haihv"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Packaging failed" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
        env:
          GITHUB_ACTIONS: "true"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/dist/velopack/*-Setup.zip
            src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/dist/velopack/*.nupkg
            src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/dist/velopack/RELEASES
            src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/dist/velopack/releases.win.json
            src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/dist/velopack/assets.win.json
          retention-days: 5

  # Temporarily disabled - MacOS build
  # build-macos:
  #   name: Build macOS (Apple Silicon)
  #   needs: prepare-version
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: "10.0.x"
  #
  #     - name: Install Velopack CLI
  #       run: dotnet tool install --global vpk
  #
  #     - name: Display locked version info
  #       run: |
  #         echo "üîí Building macOS with LOCKED version from version.json"
  #         echo "üì¶ Package Version: ${{ needs.prepare-version.outputs.version }}"
  #         echo "üî¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}"
  #         echo "‚ö†Ô∏è  No auto-increment on GitHub Actions build"
  #
  #     - name: Build macOS with Velopack (uses locked version from version.json)
  #       run: ./build/macos-velopack.sh Release arm64
  #       env:
  #         GITHUB_ACTIONS: "true"
  #         MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
  #         MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
  #         MACOS_KEYCHAIN_PWD: ${{ secrets.MACOS_KEYCHAIN_PWD }}
  #         MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
  #         MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
  #         MACOS_NOTARIZATION_PWD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
  #
  #     - name: Upload macOS artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-release
  #         path: |
  #           dist/velopack/*.dmg
  #           dist/velopack/*-Portable.zip
  #           dist/velopack/*.nupkg
  #           dist/velopack/RELEASES
  #           dist/velopack/releases.osx-arm64.json
  #           dist/velopack/assets.osx-arm64.json
  #         retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [prepare-version, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate release notes
        id: release-notes
        env:
          APP_UPDATE_NOTES_INPUT: ${{ github.event.inputs.app_update_notes }}
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          TAG_NAME="${{ needs.prepare-version.outputs.tag-name }}"

          # Find the previous tag (excluding current tag) to build a valid compare URL.
          # If this is the first tag, fall back to the commits page for the current tag.
          PREV_TAG=$(git tag --list "v*" --sort=-creatordate | grep -v "^${TAG_NAME}$" | head -n 1 || true)
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME}"
          else
            CHANGELOG_URL="https://github.com/${{ github.repository }}/commits/${TAG_NAME}"
          fi

          if [ -n "${APP_UPDATE_NOTES_INPUT:-}" ]; then
            APP_UPDATE_NOTES="$APP_UPDATE_NOTES_INPUT"
          else
            VERSION_FILE="src/Haihv.Vbdlis.Tools/Haihv.Vbdlis.Tools.Desktop/build-scripts/version.json"
            if [ -f "$VERSION_FILE" ]; then
              APP_UPDATE_NOTES=$(python3 -c 'import json,sys; d=json.load(open(sys.argv[1], encoding="utf-8")); print(d.get("appUpdateNotes",""))' "$VERSION_FILE")
            fi
          fi

          if [ -z "${APP_UPDATE_NOTES:-}" ]; then
            APP_UPDATE_NOTES=$'**01 Th√°ng 02, 2026**\n- B·ªï sung ch·ª©c nƒÉng cache cho t√¨m ki·∫øm v√† c·∫£i thi·ªán giao di·ªán\n- B·ªï sung ch·ª©c nƒÉng qu·∫£n l√Ω l·ªãch s·ª≠ t√¨m ki·∫øm\n- C·∫£i thi·ªán qu·∫£n l√Ω ƒëƒÉng nh·∫≠p v√† ghi log l·ªói\n\n**31 Th√°ng 01, 2026**\n- T√°i c·∫ßu tr√∫c giao di·ªán ch·ª©c nƒÉng t√¨m ki·∫øm.'
          fi

          {
            echo "## üéâ VBDLIS Tools v$VERSION"
            echo
            echo "<!-- APP_UPDATE_NOTES_START -->"
            echo "### ‚ú® C√≥ g√¨ m·ªõi trong phi√™n b·∫£n n√†y?"
            printf '%s\n' "$APP_UPDATE_NOTES"
            echo "<!-- APP_UPDATE_NOTES_END -->"
            echo
            echo "### üì¶ T·∫£i v·ªÅ"
            echo
            echo "#### Windows"
            echo "- **Haihv.Vbdlis.Tools.Desktop-win-Setup.zip** - B·ªô c√†i ƒë·∫∑t cho Windows (gi·∫£i n√©n v√† ch·∫°y Setup.exe)"
            echo "- H·ªó tr·ª£ t·ª± ƒë·ªông c·∫≠p nh·∫≠t qua Velopack"
            echo "- **L∆∞u √Ω:** T·∫£i file ZIP ƒë·ªÉ tr√°nh c·∫£nh b√°o c·ªßa tr√¨nh duy·ªát"
            echo
            echo "### üöÄ C√†i ƒë·∫∑t"
            echo
            echo "**Windows:**"
            echo "1. T·∫£i file \`Haihv.Vbdlis.Tools.Desktop-win-Setup.zip\`"
            echo "2. Gi·∫£i n√©n file ZIP"
            echo "3. Ch·∫°y \`Haihv.Vbdlis.Tools.Desktop-win-Setup.exe\`"
            echo "4. ·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ phi√™n b·∫£n m·ªõi"
            echo
            echo "### ‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng"
            echo
            echo "- **Tr√¨nh duy·ªát Playwright**:"
            echo "  - L·∫ßn ch·∫°y ƒë·∫ßu ti√™n, ·ª©ng d·ª•ng s·∫Ω t·∫£i c√°c tr√¨nh duy·ªát Playwright c·∫ßn thi·∫øt (kho·∫£ng 200MB)"
            echo "  - Vui l√≤ng ƒë·∫£m b·∫£o k·∫øt n·ªëi internet ·ªïn ƒë·ªãnh trong l·∫ßn ch·∫°y ƒë·∫ßu ti√™n"
            echo "- **T·ª± ƒë·ªông c·∫≠p nh·∫≠t**: ·ª®ng d·ª•ng t·ª± ƒë·ªông ki·ªÉm tra v√† c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi"
            echo "- **Y√™u c·∫ßu t·ªëi thi·ªÉu**:"
            echo "  - Windows: Windows 10 64-bit tr·ªü l√™n"
            echo "  - ~200MB dung l∆∞·ª£ng ·ªï ƒëƒ©a (bao g·ªìm tr√¨nh duy·ªát Playwright)"
            echo
            echo "---"
            echo
            echo "**Nh·∫≠t k√Ω thay ƒë·ªïi ƒë·∫ßy ƒë·ªß**: $CHANGELOG_URL"
          } > release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-version.outputs.tag-name }}
          name: Release ${{ needs.prepare-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release server (optional)
        if: false # Enable this if you have a custom release server
        run: |
          # Example: rsync or scp to your web server
          # rsync -avz artifacts/ user@server:/path/to/releases/
          echo "Upload to custom server disabled. Enable by setting 'if: true' above."
