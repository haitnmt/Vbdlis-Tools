name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.25120901
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      assembly-version: ${{ steps.get-version.outputs.assembly-version }}
      tag-name: ${{ steps.get-version.outputs.tag-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag (uses version.json - no auto-increment)
        id: get-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag (e.g., v1.0.25120901 -> 1.0.25120901)
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            # Read from version.json (for manual trigger)
            VERSION=$(cat build/version.json | grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
            TAG_NAME="v$VERSION"
          fi

          # Read assembly version from version.json
          ASSEMBLY_VERSION=$(cat build/version.json | grep -o '"assemblyVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "assembly-version=$ASSEMBLY_VERSION" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION (Assembly: $ASSEMBLY_VERSION)"
          echo "ğŸ”’ Using LOCKED version from version.json (no auto-increment)"

  build-windows:
    name: Build Windows
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Display locked version info
        run: |
          Write-Host "ğŸ”’ Building Windows with LOCKED version from version.json" -ForegroundColor Green
          Write-Host "ğŸ“¦ Package Version: ${{ needs.prepare-version.outputs.version }}" -ForegroundColor Cyan
          Write-Host "ğŸ”¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}" -ForegroundColor Cyan
          Write-Host "âš ï¸  No auto-increment on GitHub Actions build" -ForegroundColor Yellow
        shell: pwsh

      - name: Build Windows with Velopack (uses locked version from version.json)
        run: .\build\windows-velopack.ps1
        shell: pwsh
        env:
          GITHUB_ACTIONS: "true"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            dist/velopack/*-Setup.zip
            dist/velopack/*.nupkg
            dist/velopack/RELEASES
            dist/velopack/releases.win.json
            dist/velopack/assets.win.json
          retention-days: 5

  # Temporarily disabled - MacOS build
  # build-macos:
  #   name: Build macOS (Apple Silicon)
  #   needs: prepare-version
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: "10.0.x"
  #
  #     - name: Install Velopack CLI
  #       run: dotnet tool install --global vpk
  #
  #     - name: Display locked version info
  #       run: |
  #         echo "ğŸ”’ Building macOS with LOCKED version from version.json"
  #         echo "ğŸ“¦ Package Version: ${{ needs.prepare-version.outputs.version }}"
  #         echo "ğŸ”¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}"
  #         echo "âš ï¸  No auto-increment on GitHub Actions build"
  #
  #     - name: Build macOS with Velopack (uses locked version from version.json)
  #       run: ./build/macos-velopack.sh Release arm64
  #       env:
  #         GITHUB_ACTIONS: "true"
  #         MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
  #         MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
  #         MACOS_KEYCHAIN_PWD: ${{ secrets.MACOS_KEYCHAIN_PWD }}
  #         MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
  #         MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
  #         MACOS_NOTARIZATION_PWD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
  #
  #     - name: Upload macOS artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-release
  #         path: |
  #           dist/velopack/*.dmg
  #           dist/velopack/*-Portable.zip
  #           dist/velopack/*.nupkg
  #           dist/velopack/RELEASES
  #           dist/velopack/releases.osx-arm64.json
  #           dist/velopack/assets.osx-arm64.json
  #         retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [prepare-version, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          TAG_NAME="${{ needs.prepare-version.outputs.tag-name }}"

          # Find the previous tag (excluding current tag) to build a valid compare URL.
          # If this is the first tag, fall back to the commits page for the current tag.
          PREV_TAG=$(git tag --list "v*" --sort=-creatordate | grep -v "^${TAG_NAME}$" | head -n 1 || true)
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME}"
          else
            CHANGELOG_URL="https://github.com/${{ github.repository }}/commits/${TAG_NAME}"
          fi

          cat > release-notes.md << 'EOF'
          ## ğŸ‰ VBDLIS Tools v$VERSION

          <!-- APP_UPDATE_NOTES_START -->
          ### âœ¨ CÃ³ gÃ¬ má»›i trong phiÃªn báº£n nÃ y?
          **01 ThÃ¡ng 02, 2026**
          - Bá»• sung chá»©c nÄƒng cache cho tÃ¬m kiáº¿m vÃ  cáº£i thiá»‡n giao diá»‡n
          - Bá»• sung chá»©c nÄƒng quáº£n lÃ½ lá»‹ch sá»­ tÃ¬m kiáº¿m
          - Cáº£i thiá»‡n quáº£n lÃ½ Ä‘Äƒng nháº­p vÃ  ghi log lá»—i

          **31 ThÃ¡ng 01, 2026**
          - TÃ¡i cáº§u trÃºc giao diá»‡n chá»©c nÄƒng tÃ¬m kiáº¿m.
          <!-- APP_UPDATE_NOTES_END -->

          ### ğŸ“¦ Táº£i vá»

          #### Windows
          - **Haihv.Vbdlis.Tools.Desktop-win-Setup.zip** - Bá»™ cÃ i Ä‘áº·t cho Windows (giáº£i nÃ©n vÃ  cháº¡y Setup.exe)
          - Há»— trá»£ tá»± Ä‘á»™ng cáº­p nháº­t qua Velopack
          - **LÆ°u Ã½:** Táº£i file ZIP Ä‘á»ƒ trÃ¡nh cáº£nh bÃ¡o cá»§a trÃ¬nh duyá»‡t

          ### ğŸš€ CÃ i Ä‘áº·t

          **Windows:**
          1. Táº£i file `Haihv.Vbdlis.Tools.Desktop-win-Setup.zip`
          2. Giáº£i nÃ©n file ZIP
          3. Cháº¡y `Haihv.Vbdlis.Tools.Desktop-win-Setup.exe`
          4. á»¨ng dá»¥ng sáº½ tá»± Ä‘á»™ng cáº­p nháº­t khi cÃ³ phiÃªn báº£n má»›i

          ### âš ï¸ LÆ°u Ã½ quan trá»ng

          - **TrÃ¬nh duyá»‡t Playwright**:
            - Láº§n cháº¡y Ä‘áº§u tiÃªn, á»©ng dá»¥ng sáº½ táº£i cÃ¡c trÃ¬nh duyá»‡t Playwright cáº§n thiáº¿t (khoáº£ng 200MB)
            - Vui lÃ²ng Ä‘áº£m báº£o káº¿t ná»‘i internet á»•n Ä‘á»‹nh trong láº§n cháº¡y Ä‘áº§u tiÃªn
          - **Tá»± Ä‘á»™ng cáº­p nháº­t**: á»¨ng dá»¥ng tá»± Ä‘á»™ng kiá»ƒm tra vÃ  cáº­p nháº­t phiÃªn báº£n má»›i
          - **YÃªu cáº§u tá»‘i thiá»ƒu**:
            - Windows: Windows 10 64-bit trá»Ÿ lÃªn
            - ~200MB dung lÆ°á»£ng á»• Ä‘Ä©a (bao gá»“m trÃ¬nh duyá»‡t Playwright)
            
          ---

          **Nháº­t kÃ½ thay Ä‘á»•i Ä‘áº§y Ä‘á»§**: $CHANGELOG_URL
          EOF

          # Replace $VERSION with actual version
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md
          # Replace changelog URL placeholder
          sed -i "s|\$CHANGELOG_URL|$CHANGELOG_URL|g" release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-version.outputs.tag-name }}
          name: Release ${{ needs.prepare-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release server (optional)
        if: false # Enable this if you have a custom release server
        run: |
          # Example: rsync or scp to your web server
          # rsync -avz artifacts/ user@server:/path/to/releases/
          echo "Upload to custom server disabled. Enable by setting 'if: true' above."
