name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.25120901
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      assembly-version: ${{ steps.get-version.outputs.assembly-version }}
      tag-name: ${{ steps.get-version.outputs.tag-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag (uses version.json - no auto-increment)
        id: get-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag (e.g., v1.0.25120901 -> 1.0.25120901)
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            # Read from version.json (for manual trigger)
            VERSION=$(cat build/version.json | grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
            TAG_NAME="v$VERSION"
          fi

          # Read assembly version from version.json
          ASSEMBLY_VERSION=$(cat build/version.json | grep -o '"assemblyVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "assembly-version=$ASSEMBLY_VERSION" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION (Assembly: $ASSEMBLY_VERSION)"
          echo "ðŸ”’ Using LOCKED version from version.json (no auto-increment)"

  build-windows:
    name: Build Windows
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Display locked version info
        run: |
          Write-Host "ðŸ”’ Building Windows with LOCKED version from version.json" -ForegroundColor Green
          Write-Host "ðŸ“¦ Package Version: ${{ needs.prepare-version.outputs.version }}" -ForegroundColor Cyan
          Write-Host "ðŸ”¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}" -ForegroundColor Cyan
          Write-Host "âš ï¸  No auto-increment on GitHub Actions build" -ForegroundColor Yellow
        shell: pwsh

      - name: Build Windows with Velopack (uses locked version from version.json)
        run: .\build\windows-velopack.ps1
        shell: pwsh
        env:
          GITHUB_ACTIONS: "true"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            dist/velopack/*-Setup.zip
            dist/velopack/*.nupkg
            dist/velopack/RELEASES
          retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [prepare-version, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          cat > release-notes.md << 'EOF'
          ## ðŸŽ‰ VBDLIS Tools v$VERSION

          ### ðŸ“¦ Downloads

          #### Windows
          - **VbdlisTools-$VERSION-Setup.zip** - Installer cho Windows (giáº£i nÃ©n vÃ  cháº¡y Setup.exe)
          - Há»— trá»£ auto-update qua Velopack
          - **LÆ°u Ã½:** Táº£i file ZIP Ä‘á»ƒ trÃ¡nh cáº£nh bÃ¡o cá»§a trÃ¬nh duyá»‡t

          ### ðŸš€ Installation

          **Windows:**
          1. Táº£i file `VbdlisTools-$VERSION-Setup.zip`
          2. Giáº£i nÃ©n ZIP file
          3. Cháº¡y `VbdlisTools-$VERSION-Setup.exe`
          4. á»¨ng dá»¥ng tá»± Ä‘á»™ng update khi cÃ³ phiÃªn báº£n má»›i

          ### âš ï¸ Important Notes

          - **Playwright Browsers**: 
            - Láº§n cháº¡y Ä‘áº§u tiÃªn, á»©ng dá»¥ng sáº½ táº£i cÃ¡c trÃ¬nh duyá»‡t Playwright cáº§n thiáº¿t (khoáº£ng 200MB)
            - Vui lÃ²ng Ä‘áº£m báº£o káº¿t ná»‘i internet á»•n Ä‘á»‹nh trong láº§n cháº¡y Ä‘áº§u tiÃªn
          - **Auto-Update**: á»¨ng dá»¥ng tá»± Ä‘á»™ng kiá»ƒm tra vÃ  cáº­p nháº­t phiÃªn báº£n má»›i
          - **Minimum Requirements**:
            - Windows: Windows 10 64-bit or later
            - ~200MB disk space (bao gá»“m Playwright browsers)

          ### ðŸ› Bug Fixes & Improvements

          - Cáº£i thiá»‡n hiá»‡u suáº¥t
          - Sá»­a lá»—i vÃ  tá»‘i Æ°u hÃ³a

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v1.0.0...v$VERSION
          EOF

          # Replace $VERSION with actual version
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-version.outputs.tag-name }}
          name: Release ${{ needs.prepare-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release server (optional)
        if: false # Enable this if you have a custom release server
        run: |
          # Example: rsync or scp to your web server
          # rsync -avz artifacts/ user@server:/path/to/releases/
          echo "Upload to custom server disabled. Enable by setting 'if: true' above."
