name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.25120901
  workflow_dispatch: # Allow manual trigger

jobs:
  prepare-version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      assembly-version: ${{ steps.get-version.outputs.assembly-version }}
      tag-name: ${{ steps.get-version.outputs.tag-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag (uses version.json - no auto-increment)
        id: get-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from tag (e.g., v1.0.25120901 -> 1.0.25120901)
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            # Read from version.json (for manual trigger)
            VERSION=$(cat build/version.json | grep -o '"currentVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
            TAG_NAME="v$VERSION"
          fi

          # Read assembly version from version.json
          ASSEMBLY_VERSION=$(cat build/version.json | grep -o '"assemblyVersion"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "assembly-version=$ASSEMBLY_VERSION" >> $GITHUB_OUTPUT
          echo "tag-name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION (Assembly: $ASSEMBLY_VERSION)"
          echo "üîí Using LOCKED version from version.json (no auto-increment)"

  build-windows:
    name: Build Windows
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install Velopack CLI
        run: dotnet tool install --global vpk

      - name: Display locked version info
        run: |
          Write-Host "üîí Building Windows with LOCKED version from version.json" -ForegroundColor Green
          Write-Host "üì¶ Package Version: ${{ needs.prepare-version.outputs.version }}" -ForegroundColor Cyan
          Write-Host "üî¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}" -ForegroundColor Cyan
          Write-Host "‚ö†Ô∏è  No auto-increment on GitHub Actions build" -ForegroundColor Yellow
        shell: pwsh

      - name: Build Windows with Velopack (uses locked version from version.json)
        run: .\build\windows-velopack.ps1
        shell: pwsh
        env:
          GITHUB_ACTIONS: "true"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            dist/velopack/*-Setup.zip
            dist/velopack/*.nupkg
            dist/velopack/RELEASES
            dist/velopack/releases.win.json
            dist/velopack/assets.win.json
          retention-days: 5

  # Temporarily disabled - MacOS build
  # build-macos:
  #   name: Build macOS (Apple Silicon)
  #   needs: prepare-version
  #   runs-on: macos-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: "10.0.x"
  #
  #     - name: Install Velopack CLI
  #       run: dotnet tool install --global vpk
  #
  #     - name: Display locked version info
  #       run: |
  #         echo "üîí Building macOS with LOCKED version from version.json"
  #         echo "üì¶ Package Version: ${{ needs.prepare-version.outputs.version }}"
  #         echo "üî¢ Assembly Version: ${{ needs.prepare-version.outputs.assembly-version }}"
  #         echo "‚ö†Ô∏è  No auto-increment on GitHub Actions build"
  #
  #     - name: Build macOS with Velopack (uses locked version from version.json)
  #       run: ./build/macos-velopack.sh Release arm64
  #       env:
  #         GITHUB_ACTIONS: "true"
  #         MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
  #         MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
  #         MACOS_KEYCHAIN_PWD: ${{ secrets.MACOS_KEYCHAIN_PWD }}
  #         MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
  #         MACOS_NOTARIZATION_TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
  #         MACOS_NOTARIZATION_PWD: ${{ secrets.MACOS_NOTARIZATION_PWD }}
  #
  #     - name: Upload macOS artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-release
  #         path: |
  #           dist/velopack/*.dmg
  #           dist/velopack/*-Portable.zip
  #           dist/velopack/*.nupkg
  #           dist/velopack/RELEASES
  #           dist/velopack/releases.osx-arm64.json
  #           dist/velopack/assets.osx-arm64.json
  #         retention-days: 5

  create-release:
    name: Create GitHub Release
    needs: [prepare-version, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          TAG_NAME="${{ needs.prepare-version.outputs.tag-name }}"

          # Find the previous tag (excluding current tag) to build a valid compare URL.
          # If this is the first tag, fall back to the commits page for the current tag.
          PREV_TAG=$(git tag --list "v*" --sort=-creatordate | grep -v "^${TAG_NAME}$" | head -n 1 || true)
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME}"
          else
            CHANGELOG_URL="https://github.com/${{ github.repository }}/commits/${TAG_NAME}"
          fi

          cat > release-notes.md << 'EOF'
          ## üéâ VBDLIS Tools v$VERSION

          <!-- APP_UPDATE_NOTES_START -->
          ### ‚ú® C√≥ g√¨ m·ªõi trong phi√™n b·∫£n n√†y?

          **v1.0.25121704 (17 Th√°ng 12, 2025)**
          - T·ªëi ∆∞u h√≥a logic x·ª≠ l√Ω hi·ªÉn th·ªã ghi ch√∫ ph√°t h√†nh

          **v1.0.25121703 (17 Th√°ng 12, 2025)**
          - S·ª≠a l·ªói kh√¥ng hi·ªÉn th·ªã th√¥ng tin ghi ch√∫ ph√°t h√†nh khi ki·ªÉm tra b·∫£n c·∫≠p nh·∫≠t.

          **v1.0.25121702 (17 Th√°ng 12, 2025)**
          - C·∫≠p nh·∫≠t th√¥ng tin ghi ch√∫ ph√°t h√†nh trong qu√° tr√¨nh ki·ªÉm tra b·∫£n c·∫≠p nh·∫≠t.
          - S·ª≠a l·ªói kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin ch·ªß s·ª≠ d·ª•ng l√† t·ªï ch·ª©c khi c√≥ m√£ lo·∫°i t·ªï ch·ª©c.
          - Th√™m t√≠nh nƒÉng xu·∫•t d·ªØ li·ªáu ra file Excel v·ªõi h·ªôp tho·∫°i l∆∞u file v√† b·ªï sung th√¥ng b√°o tr·∫°ng th√°i sau khi xu·∫•t file th√†nh c√¥ng
          <!-- APP_UPDATE_NOTES_END -->

          ### üì¶ T·∫£i v·ªÅ

          #### Windows
          - **VbdlisTools-$VERSION-Setup.zip** - B·ªô c√†i ƒë·∫∑t cho Windows (gi·∫£i n√©n v√† ch·∫°y Setup.exe)
          - H·ªó tr·ª£ t·ª± ƒë·ªông c·∫≠p nh·∫≠t qua Velopack
          - **L∆∞u √Ω:** T·∫£i file ZIP ƒë·ªÉ tr√°nh c·∫£nh b√°o c·ªßa tr√¨nh duy·ªát

          ### üöÄ C√†i ƒë·∫∑t

          **Windows:**
          1. T·∫£i file `VbdlisTools-$VERSION-Setup.zip`
          2. Gi·∫£i n√©n file ZIP
          3. Ch·∫°y `VbdlisTools-$VERSION-Setup.exe`
          4. ·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ phi√™n b·∫£n m·ªõi

          ### ‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng

          - **Tr√¨nh duy·ªát Playwright**:
            - L·∫ßn ch·∫°y ƒë·∫ßu ti√™n, ·ª©ng d·ª•ng s·∫Ω t·∫£i c√°c tr√¨nh duy·ªát Playwright c·∫ßn thi·∫øt (kho·∫£ng 200MB)
            - Vui l√≤ng ƒë·∫£m b·∫£o k·∫øt n·ªëi internet ·ªïn ƒë·ªãnh trong l·∫ßn ch·∫°y ƒë·∫ßu ti√™n
          - **T·ª± ƒë·ªông c·∫≠p nh·∫≠t**: ·ª®ng d·ª•ng t·ª± ƒë·ªông ki·ªÉm tra v√† c·∫≠p nh·∫≠t phi√™n b·∫£n m·ªõi
          - **Y√™u c·∫ßu t·ªëi thi·ªÉu**:
            - Windows: Windows 10 64-bit tr·ªü l√™n
            - ~200MB dung l∆∞·ª£ng ·ªï ƒëƒ©a (bao g·ªìm tr√¨nh duy·ªát Playwright)
            
          ---

          **Nh·∫≠t k√Ω thay ƒë·ªïi ƒë·∫ßy ƒë·ªß**: $CHANGELOG_URL
          EOF

          # Replace $VERSION with actual version
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md
          # Replace changelog URL placeholder
          sed -i "s|\$CHANGELOG_URL|$CHANGELOG_URL|g" release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-version.outputs.tag-name }}
          name: Release ${{ needs.prepare-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to release server (optional)
        if: false # Enable this if you have a custom release server
        run: |
          # Example: rsync or scp to your web server
          # rsync -avz artifacts/ user@server:/path/to/releases/
          echo "Upload to custom server disabled. Enable by setting 'if: true' above."
